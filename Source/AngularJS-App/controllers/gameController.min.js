"use strict";app.controller("gameController",["$scope","$timeout","highscoreService","soundEffectsService",function(n,t,i,r){function e(){let r=!n.GameState.tetrominoBag.some(function(n){return n>0}),i=[],t;for(let t=1;t<=7;t++)n.GameState.tetrominoBag[t]>0&&i.push(t);if(r&&(n.GameState.tetrominoBag=JSON.parse(JSON.stringify(n.GameState.fullTetrominoBag)),i=[Tetromino.TypeEnum.LINE,Tetromino.TypeEnum.BOX,Tetromino.TypeEnum.INVERTED_T,Tetromino.TypeEnum.S,Tetromino.TypeEnum.Z,Tetromino.TypeEnum.L,Tetromino.TypeEnum.INVERTED_L]),i.length==1)t=i[0];else if(i.length<=3){let n=Math.floor(Math.random()*(i.length-1));t=i[n]}else{let i=0;for(n.GameState.tetrominoHistory.length>0&&(i=n.GameState.tetrominoHistory[n.GameState.tetrominoHistory.length-1]),t=Math.floor(Math.random()*7+1);n.GameState.tetrominoBag[t]==0||t==i;)t=Math.floor(Math.random()*7+1)}return n.GameState.tetrominoHistory.push(t),n.GameState.tetrominoBag[t]--,new Tetromino.tetromino(t)}function v(){n.GameState.running=!1;n.GameState.lines=0;n.GameState.score=0;n.GameState.level=1;n.GameState.tetrominoBag=JSON.parse(JSON.stringify(n.GameState.fullTetrominoBag));n.GameState.tetrominoHistory=[];n.GameState.IsHighscore=!1;u={Color:n.getGameColor(n.GameState),AlternateColor:s(n.getGameColor(n.GameState),50),Duration:1500-(n.level-1)*30};n.getSoundFX()&&r.play(app.SoundEffectEnum.Drop);n.GameState.fallingTetromino=n.GameState.nextTetromino?n.GameState.nextTetromino:e();n.GameState.nextTetromino=e();n.GameState.nextTetrominoSquares=Tetromino.getSquares(n.GameState.nextTetromino);n.GameState.board=new Array(Game.BoardSize.h);for(let t=0;t<Game.BoardSize.h;t++){n.GameState.board[t]=new Array(Game.BoardSize.w);for(let i=0;i<Game.BoardSize.w;i++)n.GameState.board[t][i]=0}Game.modifyBoard(n.GameState.fallingTetromino,n.GameState.board,Game.BoardActions.ADD)}function h(){if(n.getSoundFX()&&r.play(app.SoundEffectEnum.GameOver),n.GameState.running=!1,n.GameState.startButtonText="Start",n.GameState.score>0&&n.highscores)if(n.highscores.length<10)n.GameState.IsHighscore=!0;else{let t=n.highscores[n.highscores.length-1].Score;n.GameState.IsHighscore=n.GameState.score>t}$("#InfoGameover").modal("show")}function c(){if(n.GameState.running){let i=Game.checkIfTetrominoCanMoveDown(n.GameState.fallingTetromino,n.GameState.board);if(i)Game.modifyBoard(n.GameState.fallingTetromino,n.GameState.board,Game.BoardActions.REMOVE),n.GameState.fallingTetromino.y++,Game.modifyBoard(n.GameState.fallingTetromino,n.GameState.board,Game.BoardActions.ADD);else if(n.GameState.fallingTetromino.y==0)h();else{Game.modifyBoard(n.GameState.fallingTetromino,n.GameState.board,Game.BoardActions.SOLIDIFY);let f=n.GameState.level,t=0;while(Game.checkForTetris(n.GameState))t++;if(t>0){t==1?$("#Game").effect("shake",{direction:"left",distance:"5",times:3},500):t==2?$("#Game").effect("shake",{direction:"left",distance:"10",times:4},600):t==3?$("#Game").effect("shake",{direction:"left",distance:"15",times:5},700):t==4&&($("#Game").effect("shake",{direction:"left",distance:"30",times:4},500),$("#Game").effect("shake",{direction:"up",distance:"30",times:4},500));let i=25+(t-1)*15;$(".GameScoreValue").animate({fontSize:i+"px"},"fast");$(".GameScoreValue").animate({fontSize:"14px"},"fast");n.GameState.score=n.GameState.score+50*(t-1);t==4&&(n.GameState.score=n.GameState.score+500);n.getSoundFX()&&(t==1?r.play(app.SoundEffectEnum.LineComplete1):t==2?r.play(app.SoundEffectEnum.LineComplete2):t==3?r.play(app.SoundEffectEnum.LineComplete3):t==4&&r.play(app.SoundEffectEnum.LineComplete4),n.GameState.level>f&&r.play(app.SoundEffectEnum.NextLevel));u={Color:n.getGameColor(n.GameState),AlternateColor:s(n.getGameColor(n.GameState),50),Duration:1500-(n.level-1)*30}}n.getSoundFX()&&r.play(app.SoundEffectEnum.Drop);n.GameState.fallingTetromino=n.GameState.nextTetromino?n.GameState.nextTetromino:e();n.GameState.nextTetromino=e();n.GameState.nextTetrominoSquares=Tetromino.getSquares(n.GameState.nextTetromino);i=Game.checkIfTetrominoCanMoveDown(n.GameState.fallingTetromino,n.GameState.board);i?Game.modifyBoard(n.GameState.fallingTetromino,n.GameState.board,Game.BoardActions.ADD):h()}f=t(c,Game.getDelay(n.GameState))}}function l(){n.PleaseWait_GetHighscores=!0;i.get(function(t){n.PleaseWait_GetHighscores=!1;n.highscores=t},function(t){n.PleaseWait_GetHighscores=!1;alert(t)})}function s(n,t){let i=parseInt(n.slice(1),16),r=Math.round(2.55*t),u=(i>>16)+r,f=(i>>8&255)+r,e=(i&255)+r;return"#"+(16777216+(u<255?u<1?0:u:255)*65536+(f<255?f<1?0:f:255)*256+(e<255?e<1?0:e:255)).toString(16).slice(1)}function o(t,i){n.GenericModal={Title:t,Text:i};$("#InfoGeneric").modal("show")}function a(){u.AlternateColor||(u={Color:Game.Colors[1],AlternateColor:s(Game.Colors[1],50),Duration:1500});$("body").animate({backgroundColor:u.AlternateColor},{duration:1e3,complete:function(){$("body").animate({backgroundColor:u.Color},{duration:1e3,complete:function(){a()}})}})}let f=null,u={};(function(){app.getCookie("AngularTetris_Music")===!1||r.playTheme();l();a();n.GameState=new Game.gameState;let t=app.getCookie("AngularTetris_InfoWasDisplayed");t==""&&(app.setCookie("AngularTetris_InfoWasDisplayed",!0,30),$("#InfoModal").modal("show"))})();n.setMusic=function(n){n?(app.setCookie("AngularTetris_Music",!0,30),r.playTheme()):(app.setCookie("AngularTetris_Music",!1,30),r.stopTheme())};n.getMusic=function(){return!(app.getCookie("AngularTetris_Music")===!1)};n.setSoundFX=function(n){n?app.setCookie("AngularTetris_SoundFX",!0,30):app.setCookie("AngularTetris_SoundFX",!1,30)};n.getSoundFX=function(){return!(app.getCookie("AngularTetris_SoundFX")===!1)};n.saveGame=function(){app.setCookie("AngularTetris_GameState",n.GameState,365);o("Game Saved","Your current game was saved. You can return to this game any time by clicking More > Restore Game.")};n.restoreGame=function(){let t=app.getCookie("AngularTetris_GameState");t!=""?(n.startGame(),n.GameState=t,o("Game Restored","The game was restored and your score is "+n.GameState.score+". Close this window to resume your game.")):o("","You haven't saved a game previously!")};n.startGame=function(){n.GameState.running?(n.GameState.running=!1,n.GameState.paused=!0,n.GameState.startButtonText="Continue",f&&clearTimeout(f)):(n.GameState.paused||v(),n.GameState.paused=!1,n.GameState.running=!0,f=t(c,0),n.GameState.startButtonText="Pause")};n.getGameColor=Game.getGameColor;n.getSquareColor=Game.getSquareColor;n.getSquareCssClass=Game.getSquareCssClass;n.getNextTetrominoColor=Game.getNextTetrominoColor;n.saveHighscore=function(){let t={Name:$("#txtName").val(),Score:n.GameState.score};if(t.Name.length==0){o("","Please enter your name!");return}n.PleaseWait_SaveHighscores=!0;i.put(t,function(){n.PleaseWait_SaveHighscores=!1;n.GameState.IsHighscore=!1;l()},function(t){n.PleaseWait_SaveHighscores=!1;alert(t)})};n.onKeyDown=function(t){if(n.GameState.running){let i=JSON.parse(JSON.stringify(n.GameState.fallingTetromino));switch(t){case 37:i.x--;Game.checkIfTetrominoCanGoThere(i,n.GameState.board)?(n.getSoundFX()&&r.play(app.SoundEffectEnum.Rotate),Game.modifyBoard(n.GameState.fallingTetromino,n.GameState.board,Game.BoardActions.REMOVE),n.GameState.fallingTetromino.x--,Game.modifyBoard(n.GameState.fallingTetromino,n.GameState.board,Game.BoardActions.ADD)):n.getSoundFX()&&r.play(app.SoundEffectEnum.CantGoThere);break;case 38:Tetromino.rotate(i);Game.checkIfTetrominoCanGoThere(i,n.GameState.board)?(n.getSoundFX()&&r.play(app.SoundEffectEnum.Rotate),Game.modifyBoard(n.GameState.fallingTetromino,n.GameState.board,Game.BoardActions.REMOVE),Tetromino.rotate(n.GameState.fallingTetromino),Game.modifyBoard(n.GameState.fallingTetromino,n.GameState.board,Game.BoardActions.ADD)):n.getSoundFX()&&r.play(app.SoundEffectEnum.CantGoThere);break;case 39:i.x++;Game.checkIfTetrominoCanGoThere(i,n.GameState.board)?(n.getSoundFX()&&r.play(app.SoundEffectEnum.Rotate),Game.modifyBoard(n.GameState.fallingTetromino,n.GameState.board,Game.BoardActions.REMOVE),n.GameState.fallingTetromino.x++,Game.modifyBoard(n.GameState.fallingTetromino,n.GameState.board,Game.BoardActions.ADD)):n.getSoundFX()&&r.play(app.SoundEffectEnum.CantGoThere);break;case 40:i.y++;Game.checkIfTetrominoCanGoThere(i,n.GameState.board)?(Game.modifyBoard(n.GameState.fallingTetromino,n.GameState.board,Game.BoardActions.REMOVE),n.GameState.fallingTetromino.y++,Game.modifyBoard(n.GameState.fallingTetromino,n.GameState.board,Game.BoardActions.ADD)):n.getSoundFX()&&r.play(app.SoundEffectEnum.CantGoThere);break;default:return}}}}]);